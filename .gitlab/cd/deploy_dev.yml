.deploy:
  stage: deploy
  image: dtzar/helm-kubectl:3.12
  before_script:
    - export KUBECONFIG=${KUBECONFIG_DEV}
    - APP_KEY=$(head -c 32 /dev/urandom | base64)
    - echo "APP_KEY=base64:$APP_KEY" >> .env
    - cat $ENV >> .env

.deploy_swagger:
  image: dtzar/helm-kubectl:3.12
  before_script:
    - export KUBECONFIG=${KUBECONFIG_DEV}
  script:
    - kubectl create configmap core-swagger -n $KUBE_NAMESPACE
      --from-file=swagger.yaml=.openapi-${CI_COMMIT_SHORT_SHA}.yaml
      -o yaml --dry-run=client | kubectl apply -n $KUBE_NAMESPACE -f -
    - helm upgrade --install --create-namespace --wait -n $KUBE_NAMESPACE
      swagger .helm/swagger
      --values .helm/prod/values.yaml
    - kubectl rollout restart deployment swagger -n $KUBE_NAMESPACE
