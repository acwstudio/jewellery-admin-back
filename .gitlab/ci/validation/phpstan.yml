phpstan:
  image: 10.0.0.239:80/uvi/core:latest
  stage: validation
  variables:
    COMMIT_RANGE: "${CI_MERGE_REQUEST_DIFF_BASE_SHA}..${CI_COMMIT_SHA}"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  before_script:
    - composer install
  script:
    - sed -i "s/memory_limit = 128M/memory_limit = 512M/g" /etc/php81/php.ini
    - |
      IFS='
      '
      CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB "${COMMIT_RANGE}")
      if ! echo "${CHANGED_FILES}"; then CHANGED_FILES=/dev/null; fi
      php ./vendor/bin/phpstan analyse -c ./phpstan.neon $CHANGED_FILES
